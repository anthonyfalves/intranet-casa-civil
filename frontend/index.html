<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Intranet Casa Civil</title>
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
  <div class="page">
    <header class="top-bar">
      <div class="brand">
        <img src="assets/logo-casa-civil.png" alt="Logo Casa Civil" aria-hidden="true">
        <div class="brand-text">GOVERNO DO ESTADO DO MATO GROSSO</div>
      </div>
      <div class="social">
        <!-- Troque os href abaixo para os links reais das redes -->
        <a href="https://x.com/GovMatoGrosso" aria-label="Twitter">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 4s-.9 1.2-2 1.7c-.8-.9-2-1.5-3.2-1.5-2.6 0-4.6 2-4.6 4.5 0 .3 0 .6.1.9-3.7-.2-7-1.9-9.2-4.6-.4.6-.6 1.3-.6 2.1 0 1.5.8 2.9 2 3.7-.7 0-1.3-.2-1.9-.5v.1c0 2.1 1.5 3.9 3.5 4.3-.4.1-.8.2-1.3.2-.3 0-.6 0-.9-.1.6 1.8 2.3 3.1 4.3 3.1-1.6 1.3-3.5 2-5.6 2-.4 0-.7 0-1.1-.1 2 1.3 4.3 2 6.8 2 8.1 0 12.5-6.6 12.5-12.4v-.6c.8-.6 1.5-1.3 2-2.1z"></path>
          </svg>
        </a>
        <a href="https://www.youtube.com/@secom_mt" aria-label="YouTube">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3.5 7.4c.2-.8.8-1.5 1.6-1.7C6.9 5.4 9.6 5 12 5s5.1.4 6.9.7c.8.2 1.4.9 1.6 1.7.3 1.6.5 3.2.5 4.3 0 1.1-.2 2.7-.5 4.3-.2.8-.8 1.5-1.6 1.7-1.8.3-4.5.7-6.9.7s-5.1-.4-6.9-.7c-.8-.2-1.4-.9-1.6-1.7C3.2 14.4 3 12.8 3 11.7c0-1.1.2-2.7.5-4.3z"></path>
            <path d="M10.5 9.3 14 12l-3.5 2.7V9.3z"></path>
          </svg>
        </a>
        <a href="https://www.instagram.com/govmatogrosso/" aria-label="Instagram">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="5"></rect>
            <path d="M16 11.4c.1 2.5-1.8 4.6-4.2 4.6-2.4 0-4.4-2.1-4.3-4.6C7.4 9 9.3 7 11.8 7c2.4 0 4.3 1.9 4.2 4.4z"></path>
            <path d="M17.5 6.5h.01"></path>
          </svg>
        </a>
        <a href="https://www.facebook.com/govmatogrosso/" aria-label="Facebook">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 4h-2.3C10.2 4 9 5.5 9 7.8V9H7v3h2v7h3v-7h2.3l.7-3H12V7.8c0-.6.2-.8.8-.8H15V4z"></path>
          </svg>
        </a>
      </div>
    </header>

    <section class="main-grid">
      <div class="left-col">
        <a class="banner" href="#" aria-label="Aviso de feriado"></a>

        <div class="birthdays">
          <div class="birthdays-header">
            <h3>Aniversariantes</h3>
            <div class="month-nav">
              <button type="button" aria-label="Mes anterior">&#8249;</button>
              <span>dezembro</span>
              <button type="button" aria-label="Proximo mes">&#8250;</button>
            </div>
          </div>
          <ul data-birthdays></ul>
        </div>
      </div>

      <div class="right-col">
        <div class="hero-title">
          <p class="eyebrow">Intranet</p>
          <h1>Casa Civil</h1>
        </div>
        <div class="quick-links" data-quick-links></div>
      </div>
    </section>

    <section class="corporate">
      <h2>Sistemas Corporativos</h2>
      <div class="status-legend" role="note" aria-label="Legenda de status dos sistemas">
        <span class="status-legend-item">
          <span class="status-dot status-online" aria-hidden="true"></span>
          Ativo
        </span>
        <span class="status-legend-item">
          <span class="status-dot status-unstable" aria-hidden="true"></span>
          Instável (lento)
        </span>
        <span class="status-legend-item">
          <span class="status-dot status-offline" aria-hidden="true"></span>
          Fora do ar
        </span>
      </div>
      <div class="corporate-grid" data-corporate-links></div>
    </section>
  </div>

  <div class="banner-modal-root" data-banner-modal>
    <div class="banner-modal-scrim" data-banner-modal-close></div>
    <div class="banner-modal-card">
      <button class="banner-modal-nav banner-modal-nav-left" type="button" aria-label="Anterior" data-banner-modal-prev>&#8249;</button>
      <div class="banner-modal-visual" data-banner-modal-visual></div>
      <button class="banner-modal-nav banner-modal-nav-right" type="button" aria-label="Próximo" data-banner-modal-next>&#8250;</button>
      <button class="banner-modal-close" type="button" aria-label="Fechar" data-banner-modal-close>&times;</button>
    </div>
  </div>

  <script>
    // Arrays de fallback caso o backend /api/links não esteja rodando
    const fallbackLinks = {
      quickLinks: [
        { id: "casa-civil", title: "Site CASA CIVIL", desc: "Institucional", icon: "home", href: "https://www.casacivil.mt.gov.br/a-secretaria" },
        { id: "ajuda", title: "Ajuda", desc: "Sistema de Helpdesk", icon: "help", href: "https://atendimento.casacivil.mt.gov.br" },
        { id: "Contatos", title: "Contatos", desc: "Contatos do Governo de Mato Grosso", icon: "phone", href: "https://www.secom.mt.gov.br/contatos" },
        { id: "capacitacoes", title: "Capacitacoes Corporativa", desc: "Capacitacoes para os servidores pÚblicos da Casa Civil", icon: "chip", href: "https://www.casacivil.videos.mt.gov.br/index.html" },
        { id: "obras", title: "Obras do Governo", desc: "Controle de obras", icon: "building", href: "https://tv.mt.gov.br" }
      ],
      corporateSystems: [
        { id: "portal-servidor", title: "Portal do Servidor", href: "https://servicos.seplag.mt.gov.br/portalservidor/", checkUrl: "https://servicos.seplag.mt.gov.br/portalservidor/favicon.ico" },
        { id: "siga-doc", title: "Sistema SIGA-DOC", href: "https://www.sigadoc.mt.gov.br/", checkUrl: "https://www.sigadoc.mt.gov.br/favicon.ico" },
        { id: "fiplan", title: "FIPLAN", href: "https://www.fiplan.mt.gov.br/Fiplan.jsp", checkUrl: "https://www.fiplan.mt.gov.br/favicon.ico" },
        { id: "seap", title: "SEAP", href: "https://seapng.seplag.mt.gov.br/", checkUrl: "https://seapng.seplag.mt.gov.br/favicon.ico" },
        { id: "sigpas", title: "SIGPAS", href: "https://atendimento.casacivil.mt.gov.br", checkUrl: "https://atendimento.casacivil.mt.gov.br" },
        { id: "compras-publicas", title: "Compras Publicas", href: "https://aquisicoes.seplag.mt.gov.br/auth/realms/az/protocol/openid-connect/auth?client_id=compras-preparacao-app&redirect_uri=https%3A%2F%2Faquisicoes.seplag.mt.gov.br%2Fcompras-preparacao%2F%23%2F&state=6b2f3dfe-08f7-4cd9-80f2-a598f59e9992&response_mode=fragment&response_type=code&scope=openid&nonce=9caa18d4-8a4e-4455-a86e-854945f3b036", checkUrl: "https://aquisicoes.seplag.mt.gov.br/auth/realms/az/protocol/openid-connect/auth?client_id=compras-preparacao-app&redirect_uri=https%3A%2F%2Faquisicoes.seplag.mt.gov.br%2Fcompras-preparacao%2F%23%2F&state=6b2f3dfe-08f7-4cd9-80f2-a598f59e9992&response_mode=fragment&response_type=code&scope=openid&nonce=9caa18d4-8a4e-4455-a86e-854945f3b036/favicon.ico" },
        { id: "portal-aquisicao", title: "Portal de Aquisições", href: "https://aquisicoes.seplag.mt.gov.br", checkUrl: "https://aquisicoes.seplag.mt.gov.br" }
      ]
    };

    const icons = {
      home: '<svg viewBox="0 0 24 24"><path d="M4 10.5 12 4l8 6.5v7.5a2 2 0 0 1-2 2h-3.5v-5.5h-5V20H6a2 2 0 0 1-2-2v-7.5z"></path></svg>',
      help: '<svg viewBox="0 0 24 24"><path d="M12 17.5v.01"></path><path d="M10.5 9.3c.2-1.2 1.1-2.1 2.5-2.1 1.4 0 2.4 1 2.4 2.2 0 1.1-.7 1.7-1.5 2.2-.7.5-1.3 1-1.3 2v.3"></path><circle cx="12" cy="12" r="9"></circle></svg>',
      phone: '<svg viewBox="0 0 24 24"><path d="M6.5 4.5h3l1 4-2 1a12.5 12.5 0 0 0 6 6l1-2 4 1v3a2 2 0 0 1-2.2 2 15.5 15.5 0 0 1-13.8-13.8 2 2 0 0 1 2-2.2z"></path></svg>',
      chip: '<svg viewBox="0 0 24 24"><rect x="5" y="5" width="14" height="14" rx="2"></rect><path d="M9 5v-2M15 5v-2M9 21v-2M15 21v-2M5 9h-2M5 15h-2M21 9h-2M21 15h-2"></path></svg>',
      chat: '<svg viewBox="0 0 24 24"><path d="M5 16.5V6.8A2.8 2.8 0 0 1 7.8 4h8.4A2.8 2.8 0 0 1 19 6.8v6.4a2.8 2.8 0 0 1-2.8 2.8H9l-4 2.2z"></path></svg>',
      users: '<svg viewBox="0 0 24 24"><path d="M8 13.5a3.5 3.5 0 1 1 0-7 3.5 3.5 0 0 1 0 7zM17 12.5a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path><path d="M3.5 19c.4-2.5 2.7-4.5 5.5-4.5s5.1 2 5.5 4.5"></path><path d="M15.5 15c1.9 0 3.6 1.4 4 3.2"></path></svg>',
      cart: '<svg viewBox="0 0 24 24"><path d="M4 5h2l1.5 11h9L18 9H7.2"></path><circle cx="10" cy="19" r="1"></circle><circle cx="16" cy="19" r="1"></circle><path d="M4 5 3 3"></path></svg>',
      fuel: '<svg viewBox="0 0 24 24"><path d="M6 5a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v15H6V5z"></path><path d="M13 8h2l3 3v6a2 2 0 0 1-2 2h-3"></path><path d="M18 7.5a1.5 1.5 0 1 1 3 0c0 1.8-2 2-2 3"></path><path d="M6 10h7"></path></svg>',
      building: '<svg viewBox="0 0 24 24"><path d="M5 20V6.5a2 2 0 0 1 1.7-2L14 3v17"></path><path d="M14 6.5 18.5 7A2 2 0 0 1 20 9v11"></path><path d="M4 20h16"></path><path d="M8 10h2M8 13h2M8 16h2M14 10h2M14 13h2M14 16h2"></path></svg>',
      calendar: '<svg viewBox="0 0 24 24"><rect x="4" y="5" width="16" height="15" rx="2"></rect><path d="M8 3v4M16 3v4M4 10h16"></path><path d="M9 14h2v2H9zM13 14h2v2h-2z"></path></svg>'
    };

    const quickLinksContainer = document.querySelector("[data-quick-links]");
    const corporateContainer = document.querySelector("[data-corporate-links]");
    const birthdaysList = document.querySelector("[data-birthdays]");
    const bannerEl = document.querySelector(".banner");
    const bannerModal = document.querySelector("[data-banner-modal]");
    const bannerModalVisual = document.querySelector("[data-banner-modal-visual]");
    const bannerModalCloseEls = document.querySelectorAll("[data-banner-modal-close]");
    const bannerPrev = document.querySelector("[data-banner-prev]");
    const bannerNext = document.querySelector("[data-banner-next]");
    const modalPrev = document.querySelector("[data-banner-modal-prev]");
    const modalNext = document.querySelector("[data-banner-modal-next]");
    let currentBannerUrl = null;
    let bannerList = [];
    let bannerIndex = 0;
    let modalIndex = 0;
    let autoOpened = false;

    async function fetchLinks() {
      try {
        const res = await fetch("/api/links", { cache: "no-store" });
        if (!res.ok) throw new Error("links fetch failed");
        return await res.json();
      } catch {
        return fallbackLinks;
      }
    }

    async function fetchHealth(ids) {
      try {
        const res = await fetch("/api/health", { cache: "no-store" });
        if (!res.ok) throw new Error("health fetch failed");
        const data = await res.json();
        // filtra apenas os ids renderizados
        const filtered = {};
        ids.forEach((id) => {
          filtered[id] = data[id] || "offline";
        });
        return filtered;
      } catch {
        // falhou: assume offline para evidenciar indisponibilidade
        const fallback = {};
        ids.forEach((id) => (fallback[id] = "offline"));
        return fallback;
      }
    }

    function applyStatus(elements, data) {
      elements.forEach((el) => {
        const id = el.dataset.id;
        const status = data[id] || "offline";
        el.classList.remove("status-online", "status-offline", "status-unstable", "status-unknown");
        el.classList.add(
          status === "online" ? "status-online" :
          status === "offline" ? "status-offline" :
          status === "unstable" ? "status-unstable" : "status-unknown"
        );
      });
    }

    async function init() {
      const [{ quickLinks, corporateSystems }, birthdays, bannerData] = await Promise.all([
        fetchLinks(),
        fetchBirthdays(),
        fetchBanner()
    ]);
    renderQuickLinks(quickLinks);
    renderCorporate(corporateSystems);
    renderBirthdays(birthdays);
    renderBanner(bannerData.banners || []);

      // health check somente para Sistemas Corporativos
      const corporateIds = corporateSystems.map((i) => i.id);
      const health = await fetchHealth(corporateIds);
      applyStatus(corporateContainer.querySelectorAll("a"), health);

      // abre comunicado automaticamente (banner mais recente), se existir
      if (!autoOpened && bannerList.length) {
        autoOpened = true;
        openBannerModal();
      }
    }

    async function fetchBirthdays() {
      try {
        const res = await fetch("/api/birthdays", { cache: "no-store" });
        if (!res.ok) throw new Error("birthdays fetch failed");
        return await res.json();
      } catch {
        return [];
      }
    }

    async function fetchBanner() {
      try {
        const res = await fetch("/api/birthdays/banner", { cache: "no-store" });
        if (!res.ok) throw new Error("banner fetch failed");
        return await res.json();
      } catch {
        return { banners: [] };
      }
    }

    function renderQuickLinks(data) {
      data.forEach((item) => {
        const link = document.createElement("a");
        link.className = "quick-card";
        link.href = item.href;
        link.dataset.id = item.id;
        link.innerHTML = `
          <span class="icon">${icons[item.icon] || icons.home}</span>
          <div>
            <h3>${item.title}</h3>
            <p>${item.desc}</p>
          </div>
        `;
        quickLinksContainer.appendChild(link);
      });
    }

    function renderBanner(list) {
      if (!bannerEl) return;
      bannerList = Array.isArray(list) ? list : [];
      bannerIndex = 0;
      modalIndex = 0;
      if (!bannerList.length) {
        bannerEl.style.backgroundImage = "";
        bannerEl.dataset.hasBanner = "false";
        currentBannerUrl = null;
        return;
      }
      applyBannerBackground();
      bannerEl.dataset.hasBanner = "true";
    }

    function applyBannerBackground() {
      if (!bannerList.length) return;
      const item = bannerList[bannerIndex];
      currentBannerUrl = item?.url || null;
      bannerEl.style.backgroundImage = currentBannerUrl ? `url(${currentBannerUrl})` : "";
      bannerEl.dataset.hasBanner = "true";
      updateNavState();
    }

    function renderBirthdays(list) {
      birthdaysList.innerHTML = "";
      if (!list.length) {
        const li = document.createElement("li");
        li.className = "empty";
        li.textContent = "Em breve";
        birthdaysList.appendChild(li);
        return;
      }
      list.forEach((person) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <span class="day">${person.date}</span>
          <span class="name">${person.name}</span>
        `;
        birthdaysList.appendChild(li);
      });
    }

    function renderCorporate(data) {
      data.forEach((item) => {
        const link = document.createElement("a");
        link.href = item.href;
        link.textContent = item.title;
        link.dataset.id = item.id;
        link.classList.add("status-offline");
        corporateContainer.appendChild(link);
      });
    }

    // inicia app assim que o DOM estiver pronto (cobre caso o evento já tenha disparado)
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }

    function openBannerModal() {
      if (!currentBannerUrl || !bannerModal || !bannerModalVisual) return;
      modalIndex = 0;
      setModalImage();
      bannerModal.classList.add("active");
      document.body.classList.add("modal-open");
    }

    function closeBannerModal() {
      if (!bannerModal || !bannerModalVisual) return;
      bannerModal.classList.remove("active");
      document.body.classList.remove("modal-open");
      bannerModalVisual.innerHTML = "";
    }

    if (bannerEl) {
      bannerEl.addEventListener("click", (e) => {
        if (bannerEl.dataset.hasBanner === "true") {
          e.preventDefault();
          openBannerModal();
        }
      });
    }

    function updateNavState() {
      const hasMany = bannerList.length > 1;
      if (bannerPrev) bannerPrev.style.display = hasMany ? "flex" : "none";
      if (bannerNext) bannerNext.style.display = hasMany ? "flex" : "none";
      if (modalPrev) modalPrev.style.display = hasMany ? "grid" : "none";
      if (modalNext) modalNext.style.display = hasMany ? "grid" : "none";
    }

    function setModalImage() {
      if (!bannerModalVisual) return;
      const item = bannerList[modalIndex];
      const url = item?.url || null;
      bannerModalVisual.innerHTML = url ? `<img src="${url}" alt="Banner em tela cheia">` : "";
    }

    function goPrev() {
      if (!bannerList.length) return;
      modalIndex = (modalIndex - 1 + bannerList.length) % bannerList.length;
      setModalImage();
    }

    function goNext() {
      if (!bannerList.length) return;
      modalIndex = (modalIndex + 1) % bannerList.length;
      setModalImage();
    }

    if (bannerPrev) bannerPrev.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); });
    if (bannerNext) bannerNext.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); });

    bannerModalCloseEls.forEach((el) => {
      el.addEventListener("click", closeBannerModal);
    });

    if (bannerModal) {
      bannerModal.addEventListener("click", (e) => {
        if (e.target === bannerModal || e.target.classList.contains("banner-modal-scrim")) {
          closeBannerModal();
        }
      });
    }

    document.addEventListener("keyup", (e) => {
      if (e.key === "Escape" && bannerModal?.classList.contains("active")) {
        closeBannerModal();
      }
    });

    if (modalPrev) modalPrev.addEventListener("click", (e) => { e.stopPropagation(); goPrev(); });
    if (modalNext) modalNext.addEventListener("click", (e) => { e.stopPropagation(); goNext(); });
  </script>
</body>
</html>
